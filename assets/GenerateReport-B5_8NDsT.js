import{d as _,g as S,c as R,b as y,A as x,e as j,u as v,f as E,r as m,j as n,H as M,F as b,P as w}from"./index-DoWxoQev.js";import{g as L}from"./reportService-BRu79J7j.js";import{B as g,S as P}from"./Button-Daln_0w8.js";const G=async(e,r)=>{try{const s=R(e.client_id),a=(await y.post(x.dnsLogs,s,{headers:r})).data;if(!a||!a.aggregates)return console.warn(`Unexpected response format for ${e.organization_name}`),{dnsVolume:0,estimatedUsers:0};const o=a.aggregates.resolverModes.reduce((u,i)=>u+i.count,0),d=j(),c=o?Math.round(o/d/5e3):0;return{dnsVolume:o,estimatedUsers:c}}catch(s){return console.error(`Error fetching DNS data for ${e.organization_name}: ${s.message}`),{dnsVolume:0,estimatedUsers:0}}},N=(e,r,s,t)=>{if(!e.mssp_id){console.warn(`MSSP ID is missing for organization: ${e.organization_name}`);return}t[e.mssp_id]||(t[e.mssp_id]={mssp_name:e.is_mssp?e.organization_name:"",clients:[],mssp_dns_volume:0,mssp_estimated_users:0}),e.is_mssp?(t[e.mssp_id].mssp_name=e.organization_name,t[e.mssp_id].mssp_dns_volume=r,t[e.mssp_id].mssp_estimated_users=s):t[e.mssp_id].clients.push({client_name:e.organization_name,total_dns_volume:r,estimated_users:s})},T=async()=>{try{const e=_.getOrganizationList(),r=e.filter(i=>i.products.includes("PROTECT")),s=new Set(_.getSelectedMSSPs().map(i=>i.mssp_id));if(!Array.isArray(e)||s.size===0)return{success:!1,data:null,error:"No 'PROTECT' organizations or selected MSSPs available"};const t=await S(),a={};let o=0;const d=r.map(async i=>{if(s.has(i.mssp_id)){const{dnsVolume:l,estimatedUsers:h}=await G(i,t);o+=l,N(i,l,h,a)}});if(await Promise.all(d),Object.keys(a).length===0)return{success:!1,data:null,error:"No data found."};const c=D(a,o),u=L(c,"dns_volume");return{success:u.success,error:u.error}}catch(e){return _.clearSelectedMSSPs(),console.error(`Error fetching DNS volume: ${e}`),{success:!1,error:`Error fetching DNS volume: ${e.message}`}}},D=(e,r)=>{const s=[];Object.values(e).forEach(a=>{s.push({MSSP:a.mssp_name,"Client Org":"","Total DNS Volume":a.mssp_dns_volume,"Estimated Users":a.mssp_estimated_users}),a.clients.forEach(o=>{s.push({MSSP:"","Client Org":o.client_name,"Total DNS Volume":o.total_dns_volume,"Estimated Users":o.estimated_users})})});const t=r?Math.round(r/5e3):0;return s.push({MSSP:"Totals","Client Org":"","Total DNS Volume":r,"Estimated Users":t}),s},z="_GenerateReport_1b0lq_2",O="_generateReport_1b0lq_9",U="_reportActions_1b0lq_36",k="_error_1b0lq_43",p={GenerateReport:z,generateReport:O,reportActions:U,error:k};function V(){const e=v(),r=E(),{selectedMssps:s}=r.state||{selectedMssps:[]},[t,a]=m.useState(!1),[o,d]=m.useState(""),c=m.useRef(!0);m.useEffect(()=>(c.current=!0,()=>{c.current=!1}),[]);const u=async()=>{a(!0),d("");try{const l=await T();if(!l.success)throw new Error(l.error||"Failed to generate report.");setTimeout(()=>{alert("Report generated successfully and downloaded to your Downloads folder.")},100),e("/usage-report")}catch(l){console.error("Error generating report:",l),c.current&&d(`There was an error generating the report: ${l.message}`)}finally{c.current&&a(!1)}},i=()=>e("/mssp-selection");return n.jsxs("div",{className:p.GenerateReport,children:[n.jsx(M,{}),n.jsxs("div",{className:p.generateReport,children:[n.jsx("h1",{children:"Generate Billing Report"}),n.jsx(f,{mssps:s}),n.jsxs("div",{className:p.reportActions,children:[n.jsx(g,{theme:"dark",onClick:u,ariaLabel:"Generate the usage report",disabled:t,children:t?"Generating...":"Generate Report"}),n.jsx(g,{theme:"dark",onClick:i,ariaLabel:"Go back to MSSP Selection",disabled:t,children:"Go Back"})]}),o&&n.jsx("p",{className:p.error,role:"alert",children:o})]}),n.jsx(b,{}),t&&n.jsx(P,{"aria-label":"Loading, please wait..."})]})}const f=({mssps:e})=>n.jsx("ul",{children:e.map(r=>n.jsx("li",{children:r.organization_name},r.mssp_id))});f.propTypes={mssps:w.array.isRequired};export{V as default};
